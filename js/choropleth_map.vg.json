{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "title": "International Air Traffic by Country",
    "width": 800,
    "height": 420,
    "projection": { "type": "equalEarth" },
  
    "params": [
      {
        "name": "direction",
        "value": "Total",
        "bind": { "input": "select", "options": ["In", "Out", "Total"], "name": "Direction: " }
      },
      {
        "name": "type",
        "value": "Passengers",
        "bind": { "input": "select", "options": ["Passengers", "Freight", "Mail"], "name": "Type: " }
      },
      {
        "name": "year",
        "value": 2024,
        "bind": { "input": "range", "min": 1985, "max": 2024, "step": 1, "name": "Year: " }
      }
    ],
  
    "layer": [
      {
        "data": {
          "url": "https://raw.githubusercontent.com/trandungpham/FIT3179-VegaLite/refs/heads/main/js/ne_110m_admin_0_countries.topojson",
          "format": { "type": "topojson", "feature": "ne_110m_admin_0_countries" }
        },
        "mark": { "type": "geoshape", "fill": "#efefef", "stroke": "white", "strokeWidth": 0.5 }
      },
  
      {
        "data": { "url": "data/city_pairs.csv" },
        "transform": [
          { "filter": "toNumber(datum.Year) == year" },
          {
            "lookup": "Country",
            "from": {
              "data": { "url": "data/mapping.csv" },
              "key": "country",
              "fields": ["iso3", "country_normalized"]
            }
          },
          { "filter": "isValid(datum.iso3)" },

          { "calculate": "datum[type + '_' + direction]", "as": "flow_raw" },
          { "calculate": "isValid(datum.flow_raw) && length(toString(datum.flow_raw)) > 0 ? toNumber(datum.flow_raw) : 0", "as": "flow_value" },

          {
            "aggregate": [ { "op": "sum", "field": "flow_value", "as": "total_flow" } ],
            "groupby": ["iso3", "country_normalized"]
          },

          { "filter": "datum.total_flow > 0" },

          {
            "lookup": "iso3",
            "from": {
              "data": {
                "url": "https://raw.githubusercontent.com/trandungpham/FIT3179-VegaLite/refs/heads/main/js/ne_110m_admin_0_countries.topojson",
                "format": { "type": "topojson", "feature": "ne_110m_admin_0_countries" }
              },
              "key": "properties.ISO_A3",
              "fields": ["geometry"]
            },
            "as": ["geometry"]
          },
          { "filter": "isValid(datum.geometry)" }
        ],
        "mark": { "type": "geoshape", "stroke": "white", "strokeWidth": 0.5 },
        "encoding": {
          "shape": { "field": "geometry", "type": "geojson" },
          "color": {
            "field": "total_flow",
            "type": "quantitative",
            "scale": { "scheme": "blues", "clamp": true, "nice": true },
            "legend": { "title": "Flow Volume", "format": ".2s" }
          },
          "tooltip": [
            { "field": "country_normalized", "title": "Country" },
            { "field": "iso3", "title": "ISO3" },
            { "field": "total_flow", "type": "quantitative", "title": "Flow Volume", "format": ",.0f" }
          ]
        }
      }
    ]
  }
  