{
    "$schema": "https://vega.github.io/schema/vega/v5.json",
    "description": "Australia air traffic Sankey by continent, filterable by type, direction, and year.",
    "width": 900,
    "height": 520,
    "padding": 5,
    "autosize": "pad",
  
    "signals": [
      {
        "name": "type",
        "value": "Passengers",
        "bind": {"input": "select", "options": ["Passengers", "Freight", "Mail"], "name": "Type: "}
      },
      {
        "name": "direction",
        "value": "Out",
        "bind": {"input": "select", "options": ["In", "Out", "Total"], "name": "Direction: "}
      },
      {
        "name": "year",
        "value": 2024,
        "bind": {"input": "range", "min": 1985, "max": 2024, "step": 1, "name": "Year: "}
      }
    ],
  
    "data": [
      {
        "name": "raw",
        "url": "data/city_pairs.csv"
      },
      {
        "name": "cc",
        "url": "data/country_continent.csv",
        "format": {"type": "csv"}
      },
  
      
      {
        "name": "continent_totals",
        "source": "raw",
        "transform": [
          { "filter": "toNumber(datum.Year) == year" },
  
          
          {
            "formula": "datum[type + '_' + (direction === 'Total' ? 'Total' : direction)]",
            "as": "flow_raw"
          },
          {
            "formula": "isValid(datum.flow_raw) && length(toString(datum.flow_raw)) > 0 ? toNumber(datum.flow_raw) : 0",
            "as": "flow_value"
          },
  
          
          {
            "lookup": "Country",
            "from": "cc",
            "key": "Country",
            "fields": ["Continent"]
          },
  
          
          { "filter": "isValid(datum.Continent) && datum.flow_value > 0" },
  
          
          {
            "aggregate": [
              { "op": "sum", "field": "flow_value", "as": "total" }
            ],
            "groupby": ["Continent"]
          },
  
          
          {
            "formula": "direction === 'In' ? datum.Continent : 'Australia'",
            "as": "source"
          },
          {
            "formula": "direction === 'In' ? 'Australia' : datum.Continent",
            "as": "target"
          },
          { "formula": "datum.total", "as": "value" }
        ]
      },
  
      
      {
        "name": "continent_totals_totalDir",
        "source": "raw",
        "transform": [
          { "filter": "toNumber(datum.Year) == year" },
          {
            "formula": "datum[type + '_In']",
            "as": "in_raw"
          },
          {
            "formula": "datum[type + '_Out']",
            "as": "out_raw"
          },
          {
            "formula": "(isValid(datum.in_raw)?toNumber(datum.in_raw):0) + (isValid(datum.out_raw)?toNumber(datum.out_raw):0)",
            "as": "flow_value"
          },
          {
            "lookup": "Country",
            "from": "cc",
            "key": "Country",
            "fields": ["Continent"]
          },
          { "filter": "isValid(datum.Continent) && datum.flow_value > 0" },
          {
            "aggregate": [
              { "op": "sum", "field": "flow_value", "as": "total" }
            ],
            "groupby": ["Continent"]
          },
          { "formula": "'Australia'", "as": "source" },
          { "formula": "datum.Continent", "as": "target" },
          { "formula": "datum.total", "as": "value" }
        ]
      },
  
      
      {
        "name": "links",
        "source": "continent_totals",
        "transform": [
          { "filter": "direction !== 'Total'" }
        ]
      },
      {
        "name": "links_total",
        "source": "continent_totals_totalDir",
        "transform": [
          { "filter": "direction === 'Total'" }
        ]
      },
      {
        "name": "links_all",
        "transform": [
          { "sequence": {"start": 0, "stop": 1, "step": 1} }, 
          {
            "formula": "direction === 'Total' ? [] : []",
            "as": "dummy"
          }
        ]
      },
      {
        "name": "links_union",
        "source": "links"
      },
      {
        "name": "links_union_total",
        "source": "links_total"
      },
  
      
      {
        "name": "sankey",
        "transform": [
          {
            "type": "sankey",
            "source": {"data": "links"},
            "target": {"data": "links_total"},
            "key": "name"
          }
        ]
      }
    ],
  
    
    "data": [
      {
        "name": "links_active",
        "source": "links"
      },
      {
        "name": "links_active_total",
        "source": "links_total"
      },
      {
        "name": "sankey_active",
        "source": "links_active",
        "transform": [
          {
            "type": "sankey",
            "source": "source",
            "target": "target",
            "value": "value",
            "nodeKey": "name",
            "nodeAlign": "center",
            "nodeWidth": 14,
            "nodePadding": 16,
            "iterations": 32,
            "size": [{"signal": "width"}, {"signal": "height"}]
          }
        ]
      },
      {
        "name": "sankey_total",
        "source": "links_active_total",
        "transform": [
          {
            "type": "sankey",
            "source": "source",
            "target": "target",
            "value": "value",
            "nodeKey": "name",
            "nodeAlign": "center",
            "nodeWidth": 14,
            "nodePadding": 16,
            "iterations": 32,
            "size": [{"signal": "width"}, {"signal": "height"}]
          }
        ]
      }
    ],
  
    "scales": [
      {
        "name": "color",
        "type": "ordinal",
        "domain": ["Australia", "Africa", "Asia", "Europe", "North America", "South America", "Oceania", "Antarctica"],
        "range": {"scheme": "tableau10"}
      }
    ],
  
    "marks": [
      {
        "type": "path",
        "from": {"data": "sankey_active"},
        "encode": {
          "enter": {
            "stroke": [{"scale": "color", "field": "source.name"}],
            "strokeOpacity": {"value": 0.6},
            "strokeWidth": {"field": "width"},
            "tooltip": {
              "signal": "{'Flow': format(datum.value, ',.0f'), 'From': datum.source.name, 'To': datum.target.name, 'Type': type, 'Direction': direction, 'Year': year}"
            }
          },
          "update": { "path": {"field": "path"} }
        }
      },
  
      {
        "type": "path",
        "from": {"data": "sankey_total"},
        "encode": {
          "enter": {
            "stroke": [{"scale": "color", "field": "source.name"}],
            "strokeOpacity": {"value": 0.6},
            "strokeWidth": {"field": "width"},
            "tooltip": {
              "signal": "{'Flow (Total In+Out)': format(datum.value, ',.0f'), 'From': datum.source.name, 'To': datum.target.name, 'Type': type, 'Direction': 'Total', 'Year': year}"
            }
          },
          "update": { "path": {"field": "path"} }
        }
      },
  
      {
        "type": "rect",
        "from": {"data": "sankey_active.nodes"},
        "encode": {
          "enter": {
            "fill": [{"scale": "color", "field": "name"}],
            "stroke": {"value": "white"},
            "strokeWidth": {"value": 1}
          },
          "update": {
            "x": {"field": "x0"}, "x2": {"field": "x1"},
            "y": {"field": "y0"}, "y2": {"field": "y1"}
          }
        }
      },
      {
        "type": "rect",
        "from": {"data": "sankey_total.nodes"},
        "encode": {
          "enter": {
            "fill": [{"scale": "color", "field": "name"}],
            "stroke": {"value": "white"},
            "strokeWidth": {"value": 1}
          },
          "update": {
            "x": {"field": "x0"}, "x2": {"field": "x1"},
            "y": {"field": "y0"}, "y2": {"field": "y1"}
          }
        }
      },
  
      
      {
        "type": "text",
        "from": {"data": "sankey_active.nodes"},
        "encode": {
          "enter": {
            "font": {"value": "sans-serif"},
            "fontSize": {"value": 12},
            "baseline": {"value": "middle"},
            "fill": {"value": "#111"},
            "text": {"field": "name"}
          },
          "update": {
            "x": {"signal": "datum.x0 < width/2 ? datum.x1 + 6 : datum.x0 - 6"},
            "y": {"signal": "(datum.y0 + datum.y1)/2"},
            "align": {"signal": "datum.x0 < width/2 ? 'left' : 'right'"}
          }
        }
      },
      {
        "type": "text",
        "from": {"data": "sankey_total.nodes"},
        "encode": {
          "enter": {
            "font": {"value": "sans-serif"},
            "fontSize": {"value": 12},
            "baseline": {"value": "middle"},
            "fill": {"value": "#111"},
            "text": {"field": "name"}
          },
          "update": {
            "x": {"signal": "datum.x0 < width/2 ? datum.x1 + 6 : datum.x0 - 6"},
            "y": {"signal": "(datum.y0 + datum.y1)/2"},
            "align": {"signal": "datum.x0 < width/2 ? 'left' : 'right'"}
          }
        }
      }
    ]
  }
  