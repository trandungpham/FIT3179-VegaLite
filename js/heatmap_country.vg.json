{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "title": "Top 10 Countries by Volume",
    "width": 450,
    "height": 320,
    "data": { "url": "../data/city_pairs.csv" },
    "params": [
      { "name": "type", "value": "Passengers" },
      { "name": "year_min", "value": 2014 },
      { "name": "year_max", "value": 2024 },
      { "name": "top_n", "value": 15 }
    ],
  
    "transform": [
      { "calculate": "toNumber(datum.Year)", "as": "YearNum" },
      { "filter": "datum.YearNum >= year_min && datum.YearNum <= year_max" },
      { "calculate": "toNumber(datum[type + '_Total']) || 0", "as": "Value" },

      { "aggregate": [{ "op": "sum", "field": "Value", "as": "YearTotal" }], "groupby": ["Country", "YearNum"] },

      { "joinaggregate": [{ "op": "sum", "field": "YearTotal", "as": "CountryTotal" }], "groupby": ["Country"] },

      { "window": [{ "op": "rank", "as": "CountryRank" }], "sort": [{ "field": "CountryTotal", "order": "descending" }] },
      { "filter": "datum.CountryRank <= 100" }
    ],
  
    "mark": "rect",
  
    "encoding": {
      "x": {
        "field": "YearNum",
        "type": "ordinal",
        "title": "Year",
        "sort": "ascending",
        "axis": { "labelAngle": 0 }
      },
      "y": {
        "field": "Country",
        "type": "nominal",
        "title": "Top Countries by Volume",
        "sort": { "field": "CountryTotal", "order": "descending" }
      },
      "color": {
        "field": "YearTotal",
        "type": "quantitative",
        "title": {"expr": "type + ' Volume'"},
        "scale": { 
          "scheme": "blues",
          "type": "linear",
          "domain": {"expr": "type == 'Passengers' ? [1, 10000000] : type == 'Freight' ? [1, 300000] : [1, 1000]"}
        }
      },
      "tooltip": [
        { "field": "Country", "title": "Country" },
        { "field": "YearNum", "title": "Year" },
        { "field": "YearTotal", "title": "Volume (Year)", "format": ".2f" },
        { "field": "CountryTotal", "title": "Volume (Total)", "format": ".2f" }
      ]
    },
  
    "config": {
      "view": { "stroke": null },
      "axis": { "labelFontSize": 11, "titleFontSize": 12 }
    }
  }
  